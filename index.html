<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Productivity To-Do App By Eric South</title>
        <link rel="stylesheet" type="text/css" href="./node_modules/bootstrap/dist/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="./node_modules/bootstrap/dist/css/bootstrap-theme.min.css">
        <link rel="stylesheet" type="text/css" href="./node_modules/font-awesome/css/font-awesome.min.css">
        <link rel="stylesheet" type="text/css" href="./src/css/main.css">
    </head>
    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="list-container col-md-4" data-column="1">
                    
                </div>
                <div class="list-container col-md-4" data-column="2">
                    
                </div>
                <div class="list-container col-md-4" data-column="3">
                    
                </div>
            </div>
        </div>

        <!-- Dependencies -->
        <script src="./node_modules/react/dist/react.js"></script>
        <script src="./node_modules/react-dom/dist/react-dom.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="./node_modules/bootstrap/dist/js/bootstrap.js"></script>

        <!-- Main -->
        <script src="./dist/bundle.js"></script>
        <script type="text/javascript">
            $(function() {
                $(document).ready(function() {
                    var useLocalStorage = checkLocalStorage();
                    var settings = {
                        'currentWorkspace': 1,
                        'version' : '0.1',
                        'listIndex' : 2, // First index is occupied by the default list
                        'taskIndex' : 1
                    };
                    var workspaces = null;
                    var autoSave = null;

                    // If using localstorage, see if we need to do setup
                    if (useLocalStorage === true) {
                        if (localStorage.getItem('workspaces') === null || localStorage.getItem('settings') === null) {
                            workspaces = localStorageSetup();
                            settings = JSON.parse(localStorage.getItem('settings'));
                        } else {
                            workspaces = getWorkspaces();
                            settings = getSettings();
                        }

                        // loadWorkspace(settings.currentWorkspace).done(function() {
                        //     // Setup auto-save every 10 seconds
                        //     autoSave = setInterval(function(settings, workspaces) {
                        //         setSettings();
                        //         setWorkspaces();
                        //         console.log("auto-saving...");
                        //     }, 10000, settings, workspaces);
                        // });

                        // Setup auto-save every 10 seconds
                        autoSave = setInterval(function(settings, workspaces) {
                            setSettings();
                            setWorkspaces();
                            console.log("auto-saving...");
                        }, 10000, settings, workspaces);

                        loadWorkspace(settings.currentWorkspace);
                    }

                    $("body").on("change", ".todo-item:checkbox", function() {
                        if ($(this).is(':checked')) {
                            console.log("box is now checked");
                            $(this).parent().parent().addClass('checked');
                            $(this).parent().parent().find('.checkbox-label label').addClass('strikethrough');

                            // TODO add to end of completed list
                        } else {
                            console.log("box is now unchecked");
                            $(this).parent().parent().removeClass('checked');
                            $(this).parent().parent().find('.checkbox-label label').removeClass('strikethrough');

                            // TODO add back to place in to-do
                        }
                    });

                    $("body").on("keyup", '.todo-input', function(e) {
                        if (!e) e = window.event;
                        var key = e.keyCode || e.which;
                        if (key == '13') {
                            addTask($(this).attr('data-listid'), $(this).val());
                            $(this).val('');
                        }
                    });

                    function checkLocalStorage() {
                        try {
                            localStorage.setItem('test', 'test');
                            localStorage.removeItem('test');
                            return true;
                        } catch(e) {
                            return false;
                        }
                    }

                    function localStorageSetup() {
                        var settings = {
                            'currentWorkspace': 1,
                            'version' : '0.1',
                            'listIndex' : 2, // First index is occupied by the default list
                            'taskIndex' : 3 // First two indexes are examples
                        };
                        localStorage.setItem('settings', JSON.stringify(settings));

                        var workspaces = [
                            {
                                'id' : 1,
                                'title' : 'default workspace',
                                'lists' : [
                                    {
                                        'id' : 1,
                                        'column' : 1,
                                        'position': 1,
                                        'theme' : 'default',
                                        'collapsed' : false,
                                        'sort-lock' : false,
                                        'filter' : 'all',
                                        'title' : 'default list',
                                        'tasks' : {
                                            'active' : [
                                                {
                                                    id: 1,
                                                    position: 1,
                                                    text: 'This is an active task!'
                                                }
                                            ],
                                            'complete' : [
                                                {
                                                    id: 2,
                                                    position: 2,
                                                    text: 'This is a completed task!'
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        ];
                        localStorage.setItem('workspaces', JSON.stringify(workspaces));
                        return workspaces;
                    }

                    function getSettings() {
                        return JSON.parse(localStorage.getItem('settings'));
                    }

                    function setSettings() {
                        localStorage.setItem('settings', JSON.stringify(settings));
                    }

                    function getWorkspaces() {
                        return JSON.parse(localStorage.getItem('workspaces'));
                    }

                    function setWorkspaces() {
                        localStorage.setItem('workspaces', JSON.stringify(workspaces));
                    }

                    function loadWorkspace(workspaceId) {
                        // Find the correct workspace
                        for(i = 0; i < workspaces.length; i++) {
                            if (workspaces[i].id == workspaceId) {

                                // Load all lists for the workspace, but only display lists once they are whole
                                for(j = 0; j < workspaces[i].lists.length; j++) {
                                    var list = workspaces[i].lists[j];
                                    var tasksHtml = '';

                                    // Add active tasks first
                                    for(k = 0; k < list.tasks.active.length; k++) {
                                        var task = workspaces[i].lists[j].tasks.active[k];
                                        tasksHtml = tasksHtml.concat(taskHtml(list.id, task.id, task.text, false));
                                    }

                                    for(k = 0; k < list.tasks.complete.length; k++) {
                                        var task = workspaces[i].lists[j].tasks.complete[k];
                                        tasksHtml = tasksHtml.concat(taskHtml(list.id, task.id, task.text, true));
                                    }

                                    // Now we can add the list
                                    $(".list-container[data-column=" + list.column + "]").append(listHtml(list.id, list.title, tasksHtml));
                                }
                            }
                        }
                    }

                    function addList(column, title) {
                        $(".list-container[data-column=" + column + "]").append(listHtml(settings.listIndex, title));
                    }

                    function addTask(listId, taskText) {
                        $(".todo-container[data-listid=" + listId + "] .list-group")
                            .append(taskHtml(listId, settings.taskIndex, taskText, false));
                        taskIndex++;
                    }

                    function listHtml(listId, title, tasksHtml) {
                        // Allow generation without providing a task list
                        taskHtml = taskHtml || '';

                        return '<div class="project-widget" data-listid="' + listId + '">'+
                            '<header role="heading">' +
                                '<h2>' + title + '</h2>' +
                            '</header>' +
                            '<div role="content">' +
                                '<div class="widget-content no-padding">' +
                                    '<div class="form-group full-width">' +
                                        '<input type="text" class="form-control todo-input" placeholder="Add New Task" data-listid="' + listId + '">' +
                                    '</div>' +
                                    '<div class="todo-container" data-listid="' + listId + '">' +
                                        '<ul class="list-group">' + tasksHtml +
                                        '</ul>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
                    }

                    function taskHtml(listId, taskId, taskText, checked) {
                        if (checked == true) {
                            checked = 'checked';
                        } else {
                            checked = '';
                        }

                        return '<li class="list-group-item ' + checked + '" data-listid="' + listId +'" data-taskid="' + taskId + '">' +
                                '<div class="checkbox">' +
                                    '<input type="checkbox" class="todo-item">' +
                                '</div>' +
                                '<div class="checkbox-label">' +
                                    '<label>' + taskText + '</label>' +
                                '</div>' +
                            '</li>';
                    }
                });
            });
        </script>
    </body>
</html>